
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Outputting Text - Jumpstart Lab Curriculum</title>
  <meta name="author" content="Jumpstart Lab">

  
  <meta name="description" content="        Outputting Text          The first and most widely used method of debugging Ruby applications is simply outputting text data. Let&#8217;s l...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yoursite.com/debugging/outputting_text.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Jumpstart Lab Curriculum" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body  >
  <header role="banner"><hgroup>
  <h1><a href="/">Jumpstart Lab Curriculum</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yoursite.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Curriculum Index</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    <h1 class="entry-title">Outputting Text</h1>
    
  </header>
  
  <p>The first and most widely used method of debugging Ruby applications is simply outputting text data. Let&#8217;s look at a few approaches at increasing levels of expertise.</p>

<h2>Reading a Request/Response</h2>

<p>Greatly undervalued by newer Rails developers, the first step when observing unexpected behavior should be the server log and the request/response information. Let&#8217;s pick apart an example.</p>

<h3>Sample Request/Response</h3>

<p>Here&#8217;s an actual request from a sample application:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
8<br>
Started POST &quot;/products&quot; for 127.0.0.1 at 2011-07-19 12:42:48 -0700<br>
  Processing by ProductsController#create as HTML<br>
  Parameters: {&quot;utf8&quot;=&gt;&quot;â&quot;, &quot;authenticity_token&quot;=&gt;&quot;E3aGszU+Xmdq3bs9woAtMzH93zy34Z9lQqiNHwLACRY=&quot;, &quot;product&quot;=&gt;{&quot;title&quot;=&gt;&quot;Apples&quot;, &quot;price&quot;=&gt;&quot;5.99&quot;, &quot;stock&quot;=&gt;&quot;12&quot;, &quot;description&quot;=&gt;&quot;A bag of apples.&quot;, &quot;image_url&quot;=&gt;&quot;apples.jpg&quot;}, &quot;commit&quot;=&gt;&quot;Create Product&quot;}<br>
  User Load (0.3ms)  SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;id&quot; IS NULL LIMIT 1<br>
  Order Load (1.1ms)  SELECT &quot;orders&quot;.* FROM &quot;orders&quot; WHERE &quot;orders&quot;.&quot;id&quot; = 48 LIMIT 1<br>
  AREL (0.5ms)  INSERT INTO &quot;products&quot; (&quot;title&quot;, &quot;price&quot;, &quot;description&quot;, &quot;image_url&quot;, &quot;created_at&quot;, &quot;updated_at&quot;, &quot;stock&quot;) VALUES (&#39;Apples&#39;, 5.99, &#39;A bag of apples.&#39;, &#39;apples.jpg&#39;, &#39;2011-07-19 19:42:48.457003&#39;, &#39;2011-07-19 19:42:48.457003&#39;, 12)<br>
Redirected to http://localhost:3000/products/3<br>
Completed 302 Found in 117ms<br>
</p>

<p>Here are some of the facts we can learn from reading the request:</p>

<ul>
<li>Line1: It executed a <code>POST</code> request for <code>/products</code> which should trigger the <code>create</code> action of <code>ProductsController</code>. Is this the controller and action intended? Especially scrutinize the request verb, this is a common place for mixups.</li>
<li>Line2: It did attempt to execute <code>ProductsController#create</code></li>
<li>Line3: The params hash. Look for elements that are blank/nil. Is the structure reasonable? Unfortunately, because of the UTF-8 checkmark, this hash can&#8217;t be copy/pasted into the console for testing unless you&#8217;re on Ruby 1.9.2. If you have trouble navigating this hash:

<ul>
<li>Copy it from the log output</li>
<li>Paste it into a text editor</li>
<li>Remove the <code>utf8</code> key/value pair</li>
<li>Copy the result</li>
<li>Paste it into console and experiment</li>
<li>Inspect whether attributes are correctly nested, correctly named, etc</li>
</ul></li>
<li>Lines 4-6: See the SQL interactions. Particularly pay attention to <code>INSERT</code> statements. Is the information from the Line 3 params in the <code>INSERT</code> or are there a bunch of <code>nil</code> fields? The most common issue you&#8217;ll spot here is this:
<code>text
WARNING: Can't mass-assign protected attributes: [your attributes here]
</code>
In that case, look in the model for the <code>attr_accessible</code> method call and see if additional fields should be made accessible. Note that the suffix matters, so making <code>product</code> accessible will not automatically accept <code>product_id</code>, list both to allow mass-assignment via ID number or actual object.</li>
<li>Last Lines: Redirect or render and HTML status code. Usually not helpful unless the app is redirecting you somewhere unexpected.</li>
</ul>

<p>Just to say it one more time, the issue about <em>Can&#8217;t mass-assign protected attributes</em> is an incredibly common issue new Rails developers spend hours debugging. If you see the error in the log, though, it can be fixed in seconds. Just go to your model file and add the attributes to <code>attr_accessible</code>.</p>

<h2>Temporary Instructions</h2>

<p>Let&#8217;s next look at adding temporary instructions to our application.</p>

<h3>Using Warn</h3>

<p>Looking at the server log gave lots of great info, but it doesn&#8217;t help with inspecting the values of variables or instructions. For that job, use the <code>warn</code> method of Ruby&#8217;s <code>Kernel</code> object. Here&#8217;s how you might insert it into the <code>create</code> action used above:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
8<br>
9<br>
10<br>
def create<br>
  @product = Product.new(params[:product])<br>
  warn &quot;Product before save:&quot;<br>
  warn @product.inspect<br>
  if @product.save<br>
    redirect_to @product, :notice =&gt; &quot;Successfully created product.&quot;<br>
  else<br>
    render :action =&gt; &#39;new&#39;<br>
  end<br>
end<br>
</p>

<p>Then in the output log see the results:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
Product before save:<br>
#&lt;Product id: nil, title: &quot;Apples&quot;, price: nil, description: nil, image_url: nil, created_at: nil, updated_at: nil, stock: 0&gt;<br>
<br>
<br>
Started POST &quot;/products&quot; for 127.0.0.1 at 2011-07-19 13:18:26 -0700<br>
  Processing by ProductsController#create as HTML<br>
</p>

<p>Notice that the warn comes out before where the log claims it is &quot;starting&quot; the response. The <code>warn</code> is output immediately, while the normal logging operations are buffered and output all together.</p>

<p>When I use warn I&#8217;ll typically put in some label to the output, like the Product before save here. The messages for warn are just strings, so you can use \n newlines or other text formatting to make them easier to read.<br>
</p>

<h3>Raising Exceptions</h3>

<p>One of my most frequently used techniques is to intentionally raise an exception. If I wanted to check out the <code>@product</code> object during the <code>create</code> action and maybe look at the parameters of the request, I&#8217;d typically do this:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
def create<br>
  @product = Product.new(params[:product])<br>
  raise @product.inspect<br>
  if @product.save<br>
  #&#8230;<br>
</p>

<p>The <code>raise</code> will immediately halt execution and display Rails&#8217; normal error page. The <code>raise</code> method accepts one parameter, a string, which will be output as the error message.</p>

<p>With this usage you&#8217;d see something like this:</p>

<p>1<br>
2<br>
RuntimeError in ProductsController#create<br>
#&lt;Product id: nil, title: &quot;Apples&quot;, price: nil, description: nil, image_url: nil, created_at: nil, updated_at: nil, stock: 0&gt;<br>
</p>

<p>The first line specifying that it was a general <code>RuntimeError</code> exception and the second line is the message, the result of our <code>inspect</code>. Generally <code>inspect</code> is a better choice than <code>to_s</code> as it&#8217;ll show more about the object&#8217;s internal state.</p>

<p>Also, further down the page you&#8217;ll see the request&#8217;s parameters formatted in a YAML debug block.</p>

<p>This is a great debugging technique when writing Rails applications because you don&#8217;t have to dig through anything &#8211; execution halts right at your message.</p>

<p>You can even use <code>raise</code> in conjunction with Ruby&#8217;s <em>here-doc</em> and string interpolation to create a block of output:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
8<br>
9<br>
10<br>
11<br>
raise &lt;&lt;-EOS<br>
<br>
params: #{params.inspect}<br>
@product: #{@product.inspect}<br>
<br>
&gt;&gt;<br>
<br>
params: #{params.inspect}<br>
@product: #{@product.inspect}<br>
<br>
&gt;&gt;<br>
</p>

<h3>Debug Helper</h3>

<p>If you can get to the point of execution where a view template is being rendered, then you can take advantage of the <code>debug</code> helper method. It accepts one object as an argument and outputs a nicely formatted YAML representation of the object wrapped in <code>&lt;pre&gt;</code> tags. The built-in Rails stylesheet already has styles for the <code>&lt;pre&gt;</code> tags for this reason.</p>

<p>For instance, in the form used with the <code>create</code> action, I could insert <code>debug</code> like this:</p>

<p>1<br>
&lt;%= debug @product %&gt;<br>
</p>

<p>Then when the view is rendered the YAML output will be visible.</p>

<p>But there&#8217;s a serious problem with adding debug code &#8211; it tends to get left behind and sent into production! One solution I&#8217;ve used is to define this helper in <code>ApplicationHelper</code>:</p>

<p>1<br>
2<br>
3<br>
  def d(object)<br>
    debug object if Rails.env == &quot;development&quot;<br>
  end<br>
</p>

<p>Then in the view templates just use it instead of the built-in <code>debug</code>:</p>

<p>1<br>
&lt;%= d @product %&gt;<br>
</p>

<p>Now any debug code would be hidden in production. Want to take it a step further? How about this:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
def d(object)<br>
  if Rails.env == &quot;development&quot;<br>
    debug object<br>
  else<br>
    raise &quot;Debug code running in test &amp; production!&quot;<br>
  end<br>
end<br>
</p>

<p>Now, assuming that you have coverage of your views in automated tests, debug code will get caught before hitting production!</p>

<h2>A Custom Logger</h2>

<p>Let&#8217;s say you want to debug a more complex process. Maybe it involves several &quot;checkpoints&quot; across multiple methods. Or you want to build an audit trail for actions in your application. You need a custom logger.</p>

<p>It&#8217;s very easy to create and use thanks to Rails <code>ActiveSupport::BufferedLogger</code>. Imagine we want to build an audit log for our application. Start with an initializer <code>config/initializers/audit_logger.rb</code></p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
module Kernel<br>
  @@audit_log = ActiveSupport::BufferedLogger.new(&quot;log/audit.log&quot;)<br>
  def audit(message)<br>
    preamble = &quot;\n[#{caller.first}] at #{Time.now}\nMessage: &quot;<br>
    @@audit_log.add 0, preamble + message.inspect<br>
  end<br>
end<br>
</p>

<p>Then anywhere in your application call the <code>audit</code> method:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
def create<br>
  @product = Product.new(params[:product])<br>
  audit @product.inspect<br>
  if @product.save<br>
    #&#8230;<br>
</p>

<p>Pop open <code>log/audit.log</code> and you&#8217;ll find messages like this:</p>

<p>1<br>
2<br>
[/path/to/your/app/controllers/products_controller.rb:18:in `create&#39;] at 2011-07-19 14:12:16 -0700<br>
Message: &quot;#&lt;Product id: nil, title: &amp;quot;Apples&amp;quot;, price: nil, description: nil, image_url: nil, created_at: nil, updated_at: nil, stock: 0&gt;&quot;<br>
</p>

<p>Tweak the formatting to your liking, then add auditing wherever needed in your application!</p>

<h2>Heroku Logs</h2>

<p>That&#8217;s great for development, but what about accessing our logs in production?</p>

<p>The first step is to enable Heroku&#8217;s &quot;Expanded&quot; logging add-on. From within your project directory, assuming it is already running on Heroku:</p>

<p>1<br>
heroku addons:add logging:expanded<br>
</p>

<h3>Fetching Logs</h3>

<p>Getting logs from Heroku is simple:</p>

<p>1<br>
heroku logs &#8211;tail<br>
</p>

<p>Which will give you output like this:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
8<br>
$ heroku logs<br>
2010-09-16T15:13:46-07:00 app[web.1]: Processing PostController#list (for 208.39.138.12 at 2010-09-16 15:13:46) [GET]<br>
2010-09-16T15:13:46-07:00 app[web.1]: Rendering template within layouts/application<br>
2010-09-16T15:13:46-07:00 app[web.1]: Rendering post/list<br>
2010-09-16T15:13:46-07:00 app[web.1]: Rendered includes/_header (0.1ms)<br>
2010-09-16T15:13:46-07:00 app[web.1]: Completed in 74ms (View: 31, DB: 40) | 200 OK [<a href="http://myapp.heroku.com/">http://myapp.heroku.com/</a>]<br>
2010-09-16T15:13:46-07:00 heroku[router]: GET myapp.heroku.com/posts queue=0 wait=0ms service=1ms bytes=975<br>
2010-09-16T15:13:47-07:00 app[worker.1]: 2 jobs processed at 16.6761 j/s, 0 failed &#8230;<br>
</p>

<p>The marker in <code>[]</code> corresponds to the dyno generating the message. The log aggregates information from all your dynos and workers, so it&#8217;s great for tracking down complex interactions between components.</p>

<p>For more extensive discussion, check out the Heroku resource center here: <a href="http://devcenter.heroku.com/articles/logging">http://devcenter.heroku.com/articles/logging</a></p>

<h2>Exercises</h2>

<p>Grab the JSBlogger sample project, create a branch, and try out each of the following techniques:</p>

<p>1<br>
2<br>
3<br>
4<br>
git clone <a href="https://github.com/JumpstartLab/jsblogger">https://github.com/JumpstartLab/jsblogger</a><br>
cd jsblogger<br>
git checkout -b my_debugging<br>
bundle<br>
</p>

<ol>
<li>Add <code>attr_accessible :title</code> to the <code>Article</code> model. Then create an article through the web interface. Check out the log file from your server and find the warnings, notice the <code>nil</code> data in the <code>INSERT</code> statement.</li>
<li>With that <code>attr_accessible</code> still in place, use <code>warn</code> statements in the <code>create</code> action to output the state of the <code>Article</code> object after creation. Find the output in the server log.</li>
<li>Now, instead of using <code>warn</code>, try using <code>raise</code>. Observe what happens when you call <code>raise</code> on the object itself. Then add <code>.inspect</code> and trigger the <code>raise</code> again.</li>
<li>Add a call to <code>debug</code> in the <code>show.html.erb</code> to display the current article.

<ul>
<li>Extra challenge: Write a <code>d</code> helper as described above. Add it to your application&#8217;s layout so every page displays <code>@article</code> or <code>@articles</code> if they exist.</li>
</ul></li>
<li>Implement a custom logger and add log entries for each step of the article life-cycle: <code>create</code>, <code>update</code>, <code>show</code>, and <code>destroy</code>. Trigger a few of those actions and see that they&#8217;re output in the audit log.</li>
</ol>

<p>Once complete, either commit (<code>git commit</code>) or get rid of (<code>git reset --hard</code>) your changes. You can stay on the debugging branch for the next section.</p>

  
    <footer>
      
      
        <div class="sharing">
  
  
</div>

      
    </footer>
  
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Jumpstart Lab -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  


  

  

  

</body>
</html>
