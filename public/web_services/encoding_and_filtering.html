
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Encoding And Filtering - Jumpstart Lab Curriculum</title>
  <meta name="author" content="Jumpstart Lab">

  
  <meta name="description" content="        Encoding and Filtering          You are building an API and are rolling with respond_to and respond_with. They are automatically rendering ...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yoursite.com/web_services/encoding_and_filtering.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Jumpstart Lab Curriculum" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   class="no-sidebar" >
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    <h1 class="entry-title">Encoding and Filtering</h1>
    
  </header>
  
  <p>You are building an API and are rolling with <code>respond_to</code> and <code>respond_with</code>. They are automatically rendering your objects as XML and JSON.</p>

<p>Wait, they are automatically rendering your objects? Everything? Yes! If your models have any sensitive data in them, and they probably do, you&#8217;ll need to do some filtering.</p>

<h2><code>to_xml</code> and <code>to_json</code> in the Model</h2>

<p>Your easiest option is to override <code>to_xml</code> and <code>to_json</code> in the model. This works in scenarios where you have attributes that should <em>always</em> be hidden.</p>

<p>Let&#8217;s look at an <code>Article</code> object, for example:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
&gt; a = Article.last<br>
# =&gt; #&lt;Article id: 15, title: &quot;asdfasdf&quot;, body: &quot;asdf&quot;, created_at: &quot;2011-09-11 16:46:52&quot;, updated_at: &quot;2011-09-12 20:34:42&quot;, author_name: &quot;Stan&quot;, editor_id: 5&gt; <br>
&gt; puts a.to_json<br>
{&quot;article&quot;:{&quot;author_name&quot;:&quot;Stan&quot;,&quot;body&quot;:&quot;asdf&quot;,&quot;created_at&quot;:&quot;2011-09-11T16:46:52Z&quot;,&quot;editor_id&quot;:5,&quot;id&quot;:15,&quot;title&quot;:&quot;asdfasdf&quot;,&quot;updated_at&quot;:&quot;2011-09-12T20:34:42Z&quot;}}<br>
# =&gt; nil <br>
</p>

<p>In this case, the <code>editor_id</code> attribute is sensitive information. We do not want to expose it to our JSON api.</p>

<h3>Overriding <code>to_json</code> / <code>to_xml</code></h3>

<p>We open the <code>article.rb</code> model and add this method:</p>

<p>1<br>
2<br>
3<br>
def to_json<br>
  super(:except =&gt; :editor_id)<br>
end<br>
</p>

<p>This method relies on the <code>ActiveRecord::Base</code> implementation of <code>to_json</code> which accepts an <code>:except</code> blacklist of attributes. It can also accept an array of keys:</p>

<p>1<br>
2<br>
3<br>
def to_json<br>
  super(:except =&gt; [:editor_id, :updated_at])<br>
end<br>
</p>

<p>All of the listed keys will be removed. The exact same syntax can be used for <code>to_xml</code></p>

<h4>Using a Whitelist</h4>

<p>Using a whitelist is more secure but takes more maintenance. Create a <code>to_json</code> method that uses the <code>:only</code> parameter:</p>

<p>1<br>
2<br>
3<br>
def to_json<br>
  super(:only =&gt; [:title, :body, :created_at])<br>
end<br>
</p>

<p>And, again, you can use the same syntax for <code>to_xml</code>.</p>

<h4>Reducing Redundancy</h4>

<p>Using either approach you should not list the visible/invisible attributes in <em>both</em> <code>to_xml</code> and <code>to_json</code>.</p>

<p>Option one is to define a constant and reference it twice:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
8<br>
9<br>
WHITELIST_ATTRIBUTES = [:title, :body, :created_at]<br>
<br>
def to_json<br>
  super(:only =&gt; WHITELIST_ATTRIBUTES)<br>
end<br>
<br>
def to_xml<br>
  super(:only =&gt; WHITELIST_ATTRIBUTES)<br>
end<br>
</p>

<p>Option two is to use a bit of metaprogramming:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
WHITELIST_ATTRIBUTES = [:title, :body, :created_at]<br>
<br>
[:to_json, :to_xml].each do |name|<br>
  define_method(name){ super(:only =&gt; WHITELIST_ATTRIBUTES) }<br>
end<br>
</p>

<p>This works well as long as you want to filter the API <em>globally</em>.</p>

<h2>Checking Authorization</h2>

<p>More often you want to filter based on authorization rules. For instance, if the current user is an administrator then show them everything. If the current user is just a regular user then show them the filtered list. This is much harder.</p>

<p>You are working with data, which means the logic belongs in the model. But you&#8217;re dealing with authorization, which really belongs in the controller. And, at the core, you&#8217;re dealing with presentation which goes in the view. It&#8217;s tricky!</p>

<h3>Using a Decorator</h3>

<p>The best way to handle this situation is to use a decorator with the Draper gem.</p>

<p>For this approach to work properly, comment out any work done to override or filter to_json at the model level.<br>
</p>

<h4>Setup</h4>

<p>Add the <code>draper</code> gem to your <code>Gemfile</code> and run <code>bundle</code>.</p>

<h4>Generate the Decorator</h4>

<p>Then generate the decorator object:</p>

<p>1<br>
rails generate draper:decorator Article<br>
</p>

<p>Which will create <code>app/decorators/article_decorator.rb</code></p>

<h4>Use the Decorator</h4>

<p>Before we look at implementing the actual decorator, let&#8217;s set it up for use in <code>ArticlesController</code>. Presume we&#8217;re interested in converting a single <code>Article</code> into JSON using the <code>show</code> action.</p>

<p>It should, so far, look like this:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
8<br>
9<br>
10<br>
class ArticlesController &lt; ApplicationController<br>
  respond_to :json, :html<br>
<br>
  def show<br>
    @article = Article.find(params[:id])<br>
    @comment = @article.comments.new<br>
    respond_with(@article)<br>
  end<br>
#&#8230;<br>
end<br>
</p>

<p>Using the decorator is just a one-line change:</p>

<p>1<br>
2<br>
3<br>
@article = Article.find(params[:id])<br>
#becomes<br>
@article = ArticleDecorator.find(params[:id])<br>
</p>

<p>The decorator class will handle the lookup with the <code>Article</code> class and wrap the result.</p>

<h4>Decorator with Context</h4>

<p>But our purpose was to handle the authentication status in the decorator. In Draper, this is called the context. Since we don&#8217;t have an authentication system, let&#8217;s pass in a symbol representing the current user&#8217;s &quot;role&quot;, <code>:admin</code>.</p>

<p>1<br>
2<br>
@article = ArticleDecorator.find(params[:id])<br>
@article.context = :admin<br>
</p>

<p>Within the decorator, that <code>:admin</code> will be stored into the attribute <code>@context</code>.</p>

<h4>Implement the <code>to_json</code> Method</h4>

<p>Now we&#8217;re ready to actually implement the <code>to_json</code> in the decorator. We open <code>app/decorators/article_decorator.rb</code> and find this frame:</p>

<p>1<br>
2<br>
3<br>
class ArticleDecorator &lt; ApplicationDecorator<br>
  decorates :article<br>
end<br>
</p>

<p>Then we add a <code>to_json</code> method which just proxies the call to the wrapped <code>model</code>:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
class ArticleDecorator &lt; ApplicationDecorator<br>
  decorates :article<br>
<br>
  def to_json<br>
    model.to_json<br>
  end<br>
end<br>
</p>

<p>You could test that it works in your console:</p>

<p>1<br>
2<br>
3<br>
4<br>
&gt; a = ArticleDecorator.find(15)<br>
# =&gt; #&lt;ArticleDecorator:0x007fa2ca1b6a10 @model=#&lt;Article id: 15, title: &quot;asdfasdf&quot;, body: &quot;asdf&quot;, created_at: &quot;2011-09-11 16:46:52&quot;, updated_at: &quot;2011-09-12 20:34:42&quot;, author_name: &quot;Stan&quot;, editor_id: 5&gt;, @context=nil&gt; <br>
&gt; a.to_json<br>
# =&gt; &quot;{&amp;quot;article&amp;quot;:{&amp;quot;author_name&amp;quot;:&amp;quot;Stan&amp;quot;,&amp;quot;body&amp;quot;:&amp;quot;asdf&amp;quot;,&amp;quot;created_at&amp;quot;:&amp;quot;2011-09-11T16:46:52Z&amp;quot;,&amp;quot;editor_id&amp;quot;:5,&amp;quot;id&amp;quot;:15,&amp;quot;title&amp;quot;:&amp;quot;asdfasdf&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2011-09-12T20:34:42Z&amp;quot;}}&quot; <br>
</p>

<p>Then, in the <code>to_json</code>, handle the switching based on <code>context</code>:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
def to_json<br>
  if context == :admin<br>
    model.to_json<br>
  else<br>
    model.to_json(:only =&gt; :title)<br>
  end<br>
end<br>
</p>

<p>And test it in console:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
8<br>
&gt; a = ArticleDecorator.find(15)<br>
# =&gt; #&lt;ArticleDecorator:0x007fe8f5361f60 @model=#&lt;Article id: 15, title: &quot;asdfasdf&quot;, body: &quot;asdf&quot;, created_at: &quot;2011-09-11 16:46:52&quot;, updated_at: &quot;2011-09-12 20:34:42&quot;, author_name: &quot;Stan&quot;, editor_id: 5&gt;, @context=nil&gt; <br>
&gt; a.to_json<br>
# =&gt; &quot;{&amp;quot;article&amp;quot;:{&amp;quot;title&amp;quot;:&amp;quot;asdfasdf&amp;quot;}}&quot; <br>
&gt; a.context = :admin<br>
# =&gt; :admin <br>
&gt; a.to_json<br>
# =&gt; &quot;{&amp;quot;article&amp;quot;:{&amp;quot;author_name&amp;quot;:&amp;quot;Stan&amp;quot;,&amp;quot;body&amp;quot;:&amp;quot;asdf&amp;quot;,&amp;quot;created_at&amp;quot;:&amp;quot;2011-09-11T16:46:52Z&amp;quot;,&amp;quot;editor_id&amp;quot;:5,&amp;quot;id&amp;quot;:15,&amp;quot;title&amp;quot;:&amp;quot;asdfasdf&amp;quot;,&amp;quot;updated_at&amp;quot;:&amp;quot;2011-09-12T20:34:42Z&amp;quot;}}&quot; <br>
</p>

<p>Success! When context is blank you see the filtered output. When the context is <code>:admin</code> you get the full output.</p>

<h2>Exercises</h2>

<p>[TODO: JSBlogger setup]</p>

<ol>
<li>Implement a filtering <code>to_json</code> method in the <code>Article</code> model so only the <code>title</code> is returned.</li>
<li>Use a blacklist constant to generate <code>to_json</code> and <code>to_xml</code> methods in <code>Article</code> so they do <em>not</em> display the timestamps.</li>
<li>Setup the Draper gem, create an <code>ArticleDecorator</code>, and use it in the controller. Verify it works from the console.</li>
<li>Implement a <code>to_xml</code> method in the decorator which outputs only the <code>title</code> and <code>body</code> attributes.</li>
<li>Add switching to your <code>to_xml</code> so:

<ul>
<li>when the <code>context</code> is <code>:admin</code>, all attributes are output</li>
<li>when the context is <code>:trusted</code>, everything <em>except</em> the timestamps are output</li>
<li>when the context is empty, only the <code>title</code> and <code>body</code> are output.</li>
</ul></li>
</ol>

<h2>References</h2>

<ul>
<li>Rails Serialization: <a href="http://api.rubyonrails.org/classes/ActiveRecord/Serialization.html">http://api.rubyonrails.org/classes/ActiveRecord/Serialization.html</a></li>
<li>Rails <code>to_json</code> API: <a href="http://api.rubyonrails.org/classes/ActiveModel/Serializers/JSON.html">http://api.rubyonrails.org/classes/ActiveModel/Serializers/JSON.html</a></li>
<li>Draper decorators: <a href="https://github.com/jcasimir/draper">https://github.com/jcasimir/draper</a></li>
</ul>

  
</article>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Jumpstart Lab -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
</body>
</html>
