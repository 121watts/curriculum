
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Transactions - Jumpstart Lab Curriculum</title>
  <meta name="author" content="Jumpstart Lab">

  
  <meta name="description" content="        Transactions          As your business logic gets complex you may need to implement transactions. The classic example is a bank funds trans...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yoursite.com/models/transactions.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Jumpstart Lab Curriculum" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body  >
  <header role="banner"><hgroup>
  <h1><a href="/">Jumpstart Lab Curriculum</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:yoursite.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Curriculum Index</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    <h1 class="entry-title">Transactions</h1>
    
  </header>
  
  <p>As your business logic gets complex you may need to implement transactions. The classic example is a bank funds transfer from account A to account B. If the withdrawal from account A fails then the deposit to account B should either never take place or be rolled back.</p>

<h2>Basics</h2>

<p>All the complexity is handled by <code>ActiveRecord::Transactions</code>. Any model class or instance has a method named <code>.transaction</code>. When called and passed a block, that block will be executed inside a database transaction. If there&#8217;s an exception raised, the transaction will automatically be rolled back.</p>

<h3>Example</h3>

<p>Let&#8217;s work with the account transfer scenario. It could be implemented like this:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
8<br>
@account_a = Account.find_by_name(&quot;A&quot;)<br>
@account_b = Account.find_by_name(&quot;B&quot;)<br>
Account.transaction do<br>
  @account_a.balance -= transfer_amount<br>
  @account_a.save!<br>
  @account_b.balance += transfer_amount<br>
  @account_b.save!<br>
end<br>
</p>

<p>First we fetch the account objects then start a transaction with <code>Account.transaction</code>. It actually makes <em>no difference</em> which <code>ActiveRecord</code> class or instance we call this method on. We could also have used any of these:</p>

<ul>
<li><code>@account_a.transaction do</code></li>
<li><code>@account_b.transaction do</code></li>
<li><code>ActiveRecord::Base.transaction do</code></li>
<li><code>self.transaction do</code></li>
<li><code>self.class.transaction do</code></li>
</ul>

<p>The choice would make absolutely no difference in the execution. </p>

<p>Rails will open a transaction in the database engine, then start executing the block. There are three possibilities:</p>

<ol>
<li>If no exceptions occur during the block then Rails closes the transaction and the database commits the data</li>
<li>If there is an exception, Rails will tell the database to cancel the transaction and no data is changed</li>
<li>If the entire Rails process or server dies then the transaction will timeout and be cancelled by the database</li>
</ol>

<p>The critical step to notice is the use of <code>.save!</code> instead of <code>.save</code>. The former will raise an exception when the operation fails, while the latter will just return <code>false</code>. If we just used <code>.save</code> our transaction would <em>never fail</em>. If you wanted to use <code>.save</code>, here&#8217;s one possible refactoring:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
Account.transaction do<br>
  @account_a.balance -= transfer_amount<br>
  @account_b.balance += transfer_amount<br>
  raise &quot;Transaction Failed&quot; unless @account_a.save &amp;&amp; @account_b.save<br>
end<br>
</p>

<p>It&#8217;s ideal to run as few instructions as possible inside the transaction because keeping the connection open is taxing on the database. You could pull the two math operation out to save a few microseconds. Here&#8217;s a final version:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
@account_a = Account.find_by_name(&quot;A&quot;)<br>
@account_b = Account.find_by_name(&quot;B&quot;)<br>
@account_a.balance -= transfer_amount<br>
@account_b.balance += transfer_amount<br>
Account.transaction do<br>
  raise &quot;Transaction Failed&quot; unless @account_a.save &amp;&amp; @account_b.save<br>
end<br>
</p>

<h2>Callbacks</h2>

<p>There are two additional callbacks available when working with transactions.</p>

<h3><code>after_commit</code></h3>

<p>This callback fires when the transaction succeeds.</p>

<h3><code>after_rollback</code></h3>

<p>This callback fires when the transaction fails.</p>

<h2>Sample Implementation</h2>

<p>Here&#8217;s a sample model using a transaction and both callbacks:</p>

<p>1<br>
2<br>
3<br>
4<br>
5<br>
6<br>
7<br>
8<br>
9<br>
10<br>
11<br>
12<br>
13<br>
14<br>
15<br>
16<br>
17<br>
18<br>
19<br>
20<br>
21<br>
class Account &lt; ActiveRecord::Base<br>
  after_commit :transaction_success<br>
  after_rollback :transaction_failed<br>
<br>
  def transfer_funds_to(amount, target)<br>
    self.balance -= amount<br>
    target.balance += amount<br>
    Account.transaction do<br>
      raise &quot;Transaction Failed&quot; unless self.save &amp;&amp; target.save<br>
    end<br>
  end<br>
<br>
private<br>
  def transaction_success<br>
    Logger.info &quot;Transfer succeed for Account #{self.to_param}&quot;<br>
  end<br>
<br>
  def transaction_failed<br>
    Logger.warn &quot;Transfer failed for Account #{self.to_param}&quot;<br>
  end<br>
end<br>
</p>

<h2>References</h2>

<ul>
<li>Rails API for <code>ActiveRecord::Transactions</code>: <a href="http://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html">http://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html</a></li>
</ul>

  
    <footer>
      
      
        <div class="sharing">
  
  
</div>

      
    </footer>
  
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Jumpstart Lab -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  


  

  

  

</body>
</html>
